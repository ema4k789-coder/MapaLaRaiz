<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TEST BOT√ìN VOLVER - DEBUG EN VIVO</title>
    <link rel="stylesheet" href="leaflet.css" />
    <link rel="stylesheet" href="style.css" />
    <link rel="stylesheet" href="simple_popup.css" />
    <style>
        body { font-family: Arial, sans-serif; margin: 0; }
        #map { height: 100vh; width: 100%; }
        .debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 15px;
            border-radius: 8px;
            font-size: 12px;
            max-width: 400px;
            z-index: 10000;
            max-height: 300px;
            overflow-y: auto;
        }
        .debug-log {
            margin: 3px 0;
            padding: 3px;
            background: rgba(255,255,255,0.1);
            border-radius: 3px;
            font-family: monospace;
        }
        .error { color: #ff6b6b; background: rgba(255,0,0,0.2); }
        .success { color: #51cf66; background: rgba(0,255,0,0.2); }
        .warning { color: #ffd43b; background: rgba(255,255,0,0.2); }
        button { margin: 5px; padding: 8px 12px; cursor: pointer; }
    </style>
</head>
<body>
    <div id="map"></div>
    
    <div class="debug-panel">
        <h3>üîç DEBUG BOT√ìN VOLVER</h3>
        <div id="debug-log"></div>
        <button onclick="forceTestPopup()">üß™ CREAR POPUP TEST</button>
        <button onclick="clearLog()">üóëÔ∏è LIMPIAR</button>
        <button onclick="checkCurrentWidth()">üìè VER ANCHO</button>
    </div>

    <script src="leaflet.js"></script>
    <script src="app.js"></script>
    <script>
        // Sistema de logging
        function debugLog(message, type = 'info') {
            const log = document.getElementById('debug-log');
            const div = document.createElement('div');
            div.className = 'debug-log ' + type;
            div.innerHTML = `[${new Date().toLocaleTimeString()}] ${message}`;
            log.appendChild(div);
            log.scrollTop = log.scrollHeight;
            console.log(`[DEBUG] ${message}`);
        }

        function clearLog() {
            document.getElementById('debug-log').innerHTML = '';
        }

        function checkCurrentWidth() {
            debugLog(`üìè Ancho actual: ${window.innerWidth}px`, 'info');
            debugLog(`üì± ¬øModo m√≥vil? ${window.innerWidth <= 600}`, window.innerWidth <= 600 ? 'success' : 'warning');
        }

        // INTERCEPTAR bindPopup para verificar HTML generado
        const originalBindPopup = L.Marker.prototype.bindPopup;
        L.Marker.prototype.bindPopup = function(content, options) {
            debugLog(`üéØ bindPopup llamado`, 'info');
            debugLog(`üìè Ancho en bindPopup: ${window.innerWidth}px`, 'info');
            
            if (typeof content === 'string') {
                const hasVolverBtn = content.includes('popup-volver-btn');
                const hasDlBtn = content.includes('popup-dl-btn');
                
                debugLog(`üé® HTML generado:`, hasVolverBtn ? 'success' : 'error');
                debugLog(`   - ¬øTiene VOLVER? ${hasVolverBtn ? '‚úÖ S√ç' : '‚ùå NO'}`, hasVolverBtn ? 'success' : 'error');
                debugLog(`   - ¬øTiene DESCARGA? ${hasDlBtn ? '‚úÖ S√ç' : '‚ùå NO'}`, hasDlBtn ? 'success' : 'warning');
                
                // Mostrar fragmento del HTML
                const htmlPreview = content.substring(0, 300) + (content.length > 300 ? '...' : '');
                debugLog(`üìã Fragmento HTML: ${htmlPreview}`, 'info');
                
                if (window.innerWidth <= 600 && !hasVolverBtn) {
                    debugLog(`üö® CR√çTICO: Est√°s en m√≥vil pero NO hay bot√≥n VOLVER`, 'error');
                }
            }
            
            return originalBindPopup.call(this, content, options);
        };

        // INTERCEPTAR popupopen para verificar DOM real
        function setupPopupDebug() {
            if (typeof map === 'undefined') {
                debugLog(`‚è≥ Esperando que map est√© disponible...`, 'warning');
                setTimeout(setupPopupDebug, 500);
                return;
            }
            
            // Verificar que map sea un objeto Leaflet v√°lido
            if (!map || typeof map.on !== 'function') {
                debugLog(`‚ùå map no es un objeto Leaflet v√°lido`, 'error');
                debugLog(`üéØ Tipo de map: ${typeof map}`, 'error');
                debugLog(`üìã map: ${JSON.stringify(map)}`, 'error');
                return;
            }
            
            debugLog(`‚úÖ Map detectado, configurando debug de popups`, 'success');
            
            map.on('popupopen', function(e) {
            debugLog(`üéâ Evento popupopen disparado`, 'success');
            
            setTimeout(() => {
                const popup = e.popup;
                const container = popup.getElement();
                
                if (!container) {
                    debugLog(`‚ùå No se encontr√≥ contenedor del popup`, 'error');
                    return;
                }
                
                debugLog(`üì¶ Contenedor popup encontrado`, 'success');
                
                // Buscar botones espec√≠ficos
                const volverBtn = container.querySelector('.popup-volver-btn');
                const dlBtn = container.querySelector('.popup-dl-btn');
                const closeBtn = container.querySelector('.leaflet-popup-close-button');
                
                debugLog(`üîç B√∫squeda de botones:`, 'info');
                debugLog(`   - VOLVER: ${volverBtn ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO'}`, volverBtn ? 'success' : 'error');
                debugLog(`   - DESCARGA: ${dlBtn ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO'}`, dlBtn ? 'success' : 'warning');
                debugLog(`   - X CLOSE: ${closeBtn ? '‚úÖ ENCONTRADO' : '‚ùå NO ENCONTRADO'}`, closeBtn ? 'warning' : 'success');
                
                if (volverBtn) {
                    // Verificar estilos computados
                    const styles = window.getComputedStyle(volverBtn);
                    debugLog(`üé® Estilos VOLVER:`, 'info');
                    debugLog(`   - display: ${styles.display}`, styles.display === 'none' ? 'error' : 'info');
                    debugLog(`   - visibility: ${styles.visibility}`, styles.visibility === 'hidden' ? 'error' : 'info');
                    debugLog(`   - opacity: ${styles.opacity}`, styles.opacity === '0' ? 'error' : 'info');
                    debugLog(`   - z-index: ${styles.zIndex}`, 'info');
                    debugLog(`   - position: ${styles.position}`, 'info');
                    debugLog(`   - bottom: ${styles.bottom}`, 'info');
                    debugLog(`   - left: ${styles.left}`, 'info');
                    
                    // Verificar evento click
                    volverBtn.addEventListener('click', function(ev) {
                        debugLog(`üëÜ Click en VOLVER detectado`, 'success');
                        map.closePopup();
                    });
                } else {
                    debugLog(`üîç ¬øExiste en el DOM? Buscando...`, 'warning');
                    // Buscar cualquier bot√≥n con texto VOLVER
                    const allButtons = container.querySelectorAll('button');
                    allButtons.forEach(btn => {
                        debugLog(`   Bot√≥n encontrado: "${btn.textContent}"`, btn.textContent.includes('VOLVER') ? 'warning' : 'info');
                    });
                }
                
            }, 500); // Esperar m√°s tiempo para asegurar renderizado
        });
        }
        
        // Iniciar configuraci√≥n cuando el DOM est√© listo
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupPopupDebug);
        } else {
            setupPopupDebug();
        }

        // Funci√≥n para crear popup de prueba
        function forceTestPopup() {
            debugLog(`üß™ CREANDO POPUP DE PRUEBA...`, 'warning');
            
            // Crear marcador de prueba
            const testMarker = L.marker([-34.5, -58.5]).addTo(map);
            
            // HTML de prueba con bot√≥n VOLVER
            const testHtml = `
                <div class='popup-frame'>
                    <img class='frame-img' src='pizarron.png' alt=''>
                    <button class='popup-dl-btn' title='Descargar imagen'>‚¨á</button>
                    <button class='popup-volver-btn' title='Volver'>VOLVER</button>
                    <div class='frame-content'>
                        <div class='name-tag'>EP 999 - Escuela TEST</div>
                        <div class='field-line'><b>Nivel:</b> Primaria</div>
                        <div class='field-line'><b>N√∫mero:</b> 999</div>
                        <div class='field-line'><b>Localidad:</b> Test City</div>
                    </div>
                </div>
            `;
            
            testMarker.bindPopup(testHtml, {
                closeButton: false,
                className: 'mobile-popup-centered'
            });
            
            testMarker.openPopup();
            debugLog(`üéØ Popup test creado y abierto`, 'success');
        }

        // Log inicial
        debugLog(`üöÄ Sistema debug activado`, 'success');
        checkCurrentWidth();
        
        // Forzar modo m√≥vil si es necesario
        if (window.innerWidth > 600) {
            debugLog(`‚ö†Ô∏è NO est√°s en modo m√≥vil. Usa F12 ‚Üí modo responsive`, 'warning');
            debugLog(`üí° Selecciona iPhone SE (375px) o similar`, 'warning');
        }
        
        // Auto-verificar cada 5 segundos
        setInterval(checkCurrentWidth, 5000);
    </script>
</body>
</html>